/*
 * SP3000 Scanner Keypad — Board Devicetree (Zephyr 4.1 / HWMv2)
 *
 * MCU: E73-2G4M08S1C (nRF52840)
 * Matrix: 5 rows × 10 columns, row2col diodes
 * Encoder: EC11 rotary with push switch
 * LEDs: 43× SK6812Mini-E (via 74AHCT1G125 level shifter)
 * Battery: BQ24075 charger + MAX17048 fuel gauge + TPS63020 PSU
 * Crystal: 32.768 KHz on XL1/XL2 (P0.00/P0.01)
 *
 * Designed by Ceynetics (CS2025A Rev.A)
 * GPIO mapping extracted from KEYPAD.kicad_sch + KEY_MATRIX.kicad_sch
 */

/dts-v1/;
#include <nordic/nrf52840_qiaa.dtsi>
#include <dt-bindings/zmk/matrix_transform.h>
#include <dt-bindings/led/led.h>

/ {
    model = "SP3000 Keypad";
    compatible = "ceynetics,sp3000-keypad";

chosen {
    zephyr,code-partition = &code_partition;
    zephyr,sram = &sram0;
    zephyr,flash = &flash0;
    zephyr,console = &cdc_acm_uart;
    zephyr,bootloader-info = &boot_info0;
    zmk,kscan = &kscan0;
    zmk,matrix-transform = &default_transform;
    zmk,underglow = &led_strip;
    zmk,battery = &fuelgauge;
    zmk,ext-power = &ext_power;
    };

    default_transform: keymap_transform_0 {
        compatible = "zmk,matrix-transform";
        columns = <10>;
        rows = <5>;

        /*
         * Full 5×10 grid — 43 switches + encoder push.
         * Empty positions get &none in keymap.
         * Verified wiring from KiCad KEY_MATRIX.kicad_sch.
         */
        map = <
            RC(0,0) RC(0,1) RC(0,2) RC(0,3) RC(0,4) RC(0,5) RC(0,6) RC(0,7) RC(0,8) RC(0,9)
            RC(1,0) RC(1,1) RC(1,2) RC(1,3) RC(1,4) RC(1,5) RC(1,6) RC(1,7) RC(1,8) RC(1,9)
            RC(2,0) RC(2,1) RC(2,2) RC(2,3) RC(2,4) RC(2,5) RC(2,6) RC(2,7) RC(2,8) RC(2,9)
            RC(3,0) RC(3,1) RC(3,2) RC(3,3) RC(3,4) RC(3,5) RC(3,6) RC(3,7) RC(3,8) RC(3,9)
            RC(4,0) RC(4,1) RC(4,2) RC(4,3) RC(4,4) RC(4,5) RC(4,6) RC(4,7) RC(4,8) RC(4,9)
        >;
    };

    /*
     * Key Scan Matrix — GPIO Pin Mapping
     * ════════════════════════════════════
     * Extracted from KiCad by matching global label coordinates
     * to E73-2G4M08S1C pin positions (U1 at 199.39, 132.08).
     *
     * Rows (outputs, all on gpio1):
     *   ROW0=P1.00  ROW1=P1.04  ROW2=P1.06  ROW3=P1.09  ROW4=P1.11
     *
     * Columns (inputs with pull-down, mixed gpio0/gpio1):
     *   COL0=P1.10  COL1=P0.28  COL2=P1.13  COL3=P0.29  COL4=P0.31
     *   COL5=P0.30  COL6=P0.07  COL7=P0.13  COL8=P0.24  COL9=P0.09
     *
     * NOTE: COL9 (P0.09) is an NFC pin — see &uicr below.
     * NOTE: COL6 (P0.07) is a low-frequency pin — fine for matrix
     *       scanning (<10 kHz) but would be bad for high-speed I/O.
     *
     * Diode direction: row2col
     *   (D_Small at 270°, anode→row, cathode→switch/col)
     */
    kscan0: kscan_0 {
        compatible = "zmk,kscan-gpio-matrix";
        wakeup-source;
        diode-direction = "col2row";

row-gpios
            = <&gpio1  0 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>
            , <&gpio1  4 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>
            , <&gpio1  6 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>
            , <&gpio1  9 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>
            , <&gpio1 11 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>
            ;

        col-gpios
            = <&gpio1 10 GPIO_ACTIVE_HIGH>
            , <&gpio0 28 GPIO_ACTIVE_HIGH>
            , <&gpio1 13 GPIO_ACTIVE_HIGH>
            , <&gpio0 29 GPIO_ACTIVE_HIGH>
            , <&gpio0 31 GPIO_ACTIVE_HIGH>
            , <&gpio0 30 GPIO_ACTIVE_HIGH>
            , <&gpio0  7 GPIO_ACTIVE_HIGH>
            , <&gpio0 13 GPIO_ACTIVE_HIGH>
            , <&gpio0 24 GPIO_ACTIVE_HIGH>
            , <&gpio0  9 GPIO_ACTIVE_HIGH>
            ;
    };

 /*
     * External power control — required by ZMK RGB underglow.
     * This PCB has no hardware power-cut MOSFET for the LEDs
     * (U3 level shifter OE is hardwired to GND = always enabled).
     * Using P1.07 as a dummy control pin — verify this pin is
     * not routed to anything on your PCB. If it is, pick a
     * different unconnected GPIO.
     */
ext_power {
    compatible = "zmk,ext-power-generic";
    control-gpios = <&gpio0 4 GPIO_ACTIVE_LOW>;
};

    /* Rotary Encoder — EC11E09244BS (80 detents, 20 triggers/rotation) */
    sensors: sensors {
        compatible = "zmk,keymap-sensors";
        sensors = <&encoder>;
        triggers-per-rotation = <20>;
    };

    encoder: encoder_0 {
        compatible = "alps,ec11";
        a-gpios = <&gpio0 22 (GPIO_ACTIVE_HIGH | GPIO_PULL_UP)>;  /* ENC_A — P0.22 */
        b-gpios = <&gpio0 20 (GPIO_ACTIVE_HIGH | GPIO_PULL_UP)>;  /* ENC_B — P0.20 */
        steps = <80>;
        status = "okay";
    };

    /*
     * Boot retention — required for &bootloader behavior in Zephyr 4.1+
     * Uses 256 bytes at end of SRAM for retained data across resets.
     */
    sram@2003FF00 {
        compatible = "zephyr,memory-region", "mmio-sram";
        reg = <0x2003FF00 256>;
        zephyr,memory-region = "RetainedMem";
        status = "okay";

        retainedmem {
            compatible = "zephyr,retained-ram";
            status = "okay";
            #address-cells = <1>;
            #size-cells = <1>;

            boot_info0: boot_info@0 {
                compatible = "zephyr,retention";
                status = "okay";
                reg = <0x0 0x100>;
            };
        };
    };
};

/* Reduce SRAM0 by 256 bytes for boot retention area */
&sram0 {
    reg = <0x20000000 0x3FF00>;
};

/* ── NFC pins as GPIO (P0.09 used as COL9) ───────────── */
&uicr {
    nfct-pins-as-gpios;
};

/* ── GPIO ports (disabled by default in nRF52840 dtsi) ── */
&gpio0 {
    status = "okay";
};

&gpio1 {
    status = "okay";
};

/* ── GPIOTE — Required for GPIO event generation ──────── */
&gpiote {
    status = "okay";
};

/* ── DC/DC converter ─────────────────────────────────── */
/*
 * E73 module does NOT include DCCH inductor — reg0 (HV stage) N/A.
 * If your PCB has an inductor on the DCC pin, uncomment reg1 below
 * for improved power efficiency (~3.3V from battery via internal DC/DC).
 *
 * Verify with your schematic whether DCC has an inductor connected.
 */
/* &reg1 { regulator-initial-mode = <NRF5X_REG_MODE_DCDC>; }; */

/* ── USB ─────────────────────────────────────────────── */
&usbd {
    status = "okay";
    cdc_acm_uart: cdc_acm_uart {
        compatible = "zephyr,cdc-acm-uart";
    };
};

/* ── I2C0 — MAX17048 fuel gauge (0x36) ───────────────── */
&i2c0 {
    compatible = "nordic,nrf-twi";
    status = "okay";
    pinctrl-0 = <&i2c0_default>;
    pinctrl-1 = <&i2c0_sleep>;
    pinctrl-names = "default", "sleep";

    fuelgauge: max17048@36 {
        /*
         * ZMK uses its own sensor-based driver, not Zephyr's upstream
         * fuel gauge API driver. The compatible was namespaced since
         * ZMK's Zephyr 3.5 update.
         * If ZMK merges upstream support, change to "maxim,max17048".
         */
        compatible = "zmk,maxim-max17048";
        reg = <0x36>;
        status = "okay";
    };
};

/* ── SPI3 — SK6812Mini-E LED strip (43 LEDs) ─────────── */
/*
 * LED data: P1.02 (MOSI) → 74AHCT1G125 level shifter → 5V LED chain.
 *
 * WARNING: P1.02 is a low-frequency pin. The SPI peripheral drives it
 * at 4 MHz which exceeds the 10 kHz recommendation for BLE reliability.
 * This is a PCB design constraint — cannot be changed in firmware.
 * If you experience BLE dropouts while LEDs are active, reduce
 * SPI frequency or disable RGB underglow.
 *
 * SCK and MISO are required by the SPI peripheral but unused for
 * WS2812. Assigned to P0.05 and P0.26 (verify these are unrouted
 * on your PCB — if they connect to anything, pick different free pins).
 */
&spi3 {
    compatible = "nordic,nrf-spim";
    status = "okay";
    pinctrl-0 = <&spi3_default>;
    pinctrl-1 = <&spi3_sleep>;
    pinctrl-names = "default", "sleep";

    led_strip: ws2812@0 {
        compatible = "worldsemi,ws2812-spi";
        reg = <0>;
        spi-max-frequency = <4000000>;
        chain-length = <43>;
        spi-one-frame = <0x70>;
        spi-zero-frame = <0x40>;
        color-mapping = <LED_COLOR_ID_GREEN LED_COLOR_ID_RED LED_COLOR_ID_BLUE>;
    };
};

/* ── Pin Control ─────────────────────────────────────── */
&pinctrl {
    i2c0_default: i2c0_default {
        group1 {
            psels = <NRF_PSEL(TWIM_SDA, 0, 2)>,    /* SDA — P0.02 */
                    <NRF_PSEL(TWIM_SCL, 0, 3)>;     /* SCL — P0.03 */
        };
    };

    i2c0_sleep: i2c0_sleep {
        group1 {
            psels = <NRF_PSEL(TWIM_SDA, 0, 2)>,    /* SDA — P0.02 */
                    <NRF_PSEL(TWIM_SCL, 0, 3)>;     /* SCL — P0.03 */
            low-power-enable;
        };
    };

    spi3_default: spi3_default {
        group1 {
            psels = <NRF_PSEL(SPIM_MOSI, 1, 2)>,    /* LED_DATA — P1.02 */
                    <NRF_PSEL(SPIM_SCK,  0, 5)>,     /* Unused — P0.05 (verify unrouted) */
                    <NRF_PSEL(SPIM_MISO, 0, 26)>;    /* Unused — P0.26 (verify unrouted) */
        };
    };

    spi3_sleep: spi3_sleep {
        group1 {
            psels = <NRF_PSEL(SPIM_MOSI, 1, 2)>,    /* LED_DATA — P1.02 */
                    <NRF_PSEL(SPIM_SCK,  0, 5)>,     /* Unused — P0.05 (verify unrouted) */
                    <NRF_PSEL(SPIM_MISO, 0, 26)>;    /* Unused — P0.26 (verify unrouted) */
            low-power-enable;
        };
    };
};

/* ── Flash partitions (Adafruit nRF52 Bootloader layout) ── */
/*
 * Standard partition layout for E73 with Adafruit bootloader.
 * Bootloader occupies first 0x26000 (152KB) and last 0xC000 (48KB).
 * If using bare metal J-Link (no bootloader), code_partition can
 * start at 0x0 and expand to fill the whole 1MB flash.
 */
&flash0 {
    partitions {
        compatible = "fixed-partitions";
        #address-cells = <1>;
        #size-cells = <1>;

        /* Reserved for SoftDevice / MBR / Adafruit bootloader stage 1 */
        sd_partition: partition@0 {
            reg = <0x00000000 0x00026000>;
        };

        /* Application code — 792 KB */
        code_partition: partition@26000 {
            reg = <0x00026000 0x000c6000>;
        };

        /* NVS settings storage — 32 KB */
        storage_partition: partition@ec000 {
            reg = <0x000ec000 0x00008000>;
        };

        /* Adafruit bootloader stage 2 — 48 KB */
        boot_partition: partition@f4000 {
            reg = <0x000f4000 0x0000c000>;
        };
    };
};
